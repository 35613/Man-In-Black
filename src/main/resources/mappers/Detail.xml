<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eagle.repository.mapper.Detail">

<select id="do_selectProductDetail" parameterType="int" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT A.PHOTO_SEQ
	, A.STORED_NAME
	, B.PRO_SEQ
	, B.BODYTYPE
	, B.PRO_NAME
	, B.PRO_CONTENT
	, B.PRO_DETAIL
	, B.WASH
	, B.MATERIAL
	, B.PRO_PRICE
	, B.BODYTYPE
	, (SELECT ROUND(AVG(SCORE))
		FROM REVIEW
		WHERE PRO_SEQ=#{PRO_SEQ}
		AND NOT SCORE IS NULL
		) AS AVG_SCORE
FROM PHOTO A INNER JOIN PRODUCT B
ON A.PRO_SEQ = B.PRO_SEQ
WHERE B.PRO_SEQ=#{PRO_SEQ}
</select>

<select id="do_selectProductColor" parameterType="int" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT DISTINCT COLOR
FROM PRO_DETAIL
WHERE PRO_SEQ=#{PRO_SEQ}
</select>

<select id="do_selectProductSize" parameterType="int" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT DISTINCT PRO_SIZE
FROM PRO_DETAIL
WHERE PRO_SEQ=#{PRO_SEQ}
</select>

<select id="do_buyProductPop" parameterType="int" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT A.PRO_SEQ
		, A.PRO_NAME
		, A.PRO_CONTENT
		,B.COLOR
		,B.PRO_SIZE
		,B.STOCK 
FROM PRODUCT A INNER JOIN PRO_DETAIL B
ON A.PRO_SEQ = B.PRO_SEQ
WHERE A.PRO_SEQ=#{PRO_SEQ}
</select>

<select id="do_buyProductColorPop" parameterType="int" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT DISTINCT B.COLOR 
FROM PRODUCT A INNER JOIN PRO_DETAIL B
ON A.PRO_SEQ = B.PRO_SEQ
WHERE A.PRO_SEQ=#{PRO_SEQ}
</select>

<select id="do_buyProductSizePop" parameterType="hashmap" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT DISTINCT PRO_SIZE, STOCK
FROM PRO_DETAIL
WHERE PRO_SEQ=#{PRO_SEQ} AND COLOR=#{COLOR}
</select>

<select id="do_buyProductStockPop" parameterType="hashmap" resultType="String">
SELECT DISTINCT STOCK
FROM PRO_DETAIL
WHERE PRO_SEQ=#{PRO_SEQ} AND COLOR=#{COLOR} AND PRO_SIZE=#{PRO_SIZE}
</select>

<insert id="do_addBasket" parameterType="hashmap">
INSERT INTO BASKET (BAS_SEQ, PRO_SEQ, USER_ID, PRO_SIZE, COLOR, BAS_PRO_NUM)
VALUES(BAS_SEQ.NEXTVAL,#{PRO_SEQ},#{USER_ID},#{PRO_SIZE},#{COLOR},#{BAS_PRO_NUM})
</insert>

<select id="do_selectProductReviewList" parameterType="hashmap" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT TT1.*
FROM (
	SELECT ROWNUM RNUM,T1.*,T2.*
	FROM(

		SELECT A.REV_SEQ	
			, A.USER_ID	
			, A.REV_TIME	
			, A.REV_TITLE	
			, A.SCORE
		    , (SELECT ROUND(AVG(SCORE))
		  		FROM REVIEW
		  		WHERE PRO_SEQ=#{PRO_SEQ}
				) AS AVG_SCORE
			, B.STORED_NAME
FROM REVIEW A LEFT JOIN PHOTO B
ON A.REV_SEQ = B.REV_SEQ
WHERE A.PRO_SEQ=#{PRO_SEQ}
ORDER BY A.REV_REF DESC, A.REV_SEQ ASC
    
	) T1 
	NATURAL JOIN(

		SELECT COUNT(*) TOT_CNT
		FROM(
			SELECT COUNT(A.REV_SEQ)
			FROM  REVIEW A LEFT JOIN PHOTO B 
			ON A.REV_SEQ=B.REV_SEQ 
			WHERE A.PRO_SEQ=#{PRO_SEQ}                 
			GROUP BY A.REV_SEQ
		) 

	) T2
) TT1
WHERE RNUM BETWEEN (#{PAGE_SIZE} * (#{PAGE_NUM}-1)+1) and ((#{PAGE_SIZE}*(#{PAGE_NUM}-1))+#{PAGE_SIZE})
</select>

<select id="do_selectReviewDetail" parameterType="int" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT 
A.REV_SEQ,
A.REV_TITLE,
A.REV_CONTENT,
A.REV_TIME,
A.SCORE,
A.REV_REF,
A.USER_ID,
A.PRO_SEQ,
A.REV_STEP,
B.STORED_NAME
FROM REVIEW A JOIN PHOTO B
ON A.REV_SEQ = B.REV_SEQ
WHERE A.REV_SEQ=#{REV_SEQ}
</select>

<insert id="do_insertReviewAdmReply" parameterType="hashmap">
INSERT INTO REVIEW (REV_SEQ, REV_TIME, REV_TITLE, REV_CONTENT, SCORE, REV_REF, USER_ID, PRO_SEQ, REV_STEP)
VALUES(REV_SEQ.NEXTVAL, SYSDATE, #{REV_TITLE}, #{REV_CONTENT}, NULL, #{REV_REF}, #{USER_ID}, #{PRO_SEQ}, NULL)
</insert>

<select id="do_selectProductQnAList" parameterType="hashmap" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT TT1.*
FROM (
	SELECT ROWNUM RNUM,T1.*,T2.*
	FROM(

SELECT QNA_SEQ,QNA_OPEN,QNA_TYPE,QNA_TITLE,QNA_REF,USER_ID,QNA_TIME
FROM QNA
WHERE PRO_SEQ=#{PRO_SEQ}
ORDER BY QNA_REF DESC, QNA_SEQ ASC
    
	) T1 
	NATURAL JOIN(

		SELECT COUNT(*) TOT_CNT
		FROM(
			SELECT COUNT(QNA_SEQ)
			FROM  QNA
			WHERE PRO_SEQ=#{PRO_SEQ}                 
			GROUP BY QNA_SEQ
		) 

	) T2
) TT1
WHERE RNUM BETWEEN (#{PAGE_SIZE} * (#{PAGE_NUM}-1)+1) and ((#{PAGE_SIZE}*(#{PAGE_NUM}-1))+#{PAGE_SIZE})
</select>

<!-- <select id="do_selectQnADetail" parameterType="int" resultType="com.eagle.men_in_black.model.DetailDto">
SELECT *
FROM QNA
WHERE QNA_SEQ=#{QNA_SEQ}
</select> -->

</mapper>