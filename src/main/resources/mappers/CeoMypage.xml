<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.eagle.repository.mapper.CeoMypage">

<select id="do_ceomypage_main" parameterType="hashmap" resultType="com.eagle.men_in_black.model.CeoMypageDto" >
SELECT TT1.*
  FROM (
       SELECT ROWNUM RNUM,T1.*,T2.*
       FROM(
            SELECT Z.*, Y.STORED_NAME, X.STOCK, W.DEL_STEP
            FROM(
                 SELECT B.ITEM, B.PRO_NAME, B.PRO_PRICE 
                 , A.SEL_TIME SELTIME, A.SEL_COLOR SEL_COLOR,
                 A.SEL_SIZE SEL_SIZE, A.PRO_SEQ, A.SEL_SEQ,A.SEL_NUM 
                 ,A.POINT,A.COUPON,A.FINAL_PRICE,A.SEL_TIME,A.USER_ID,A.DEL_SEQ   
                 FROM SALES A LEFT OUTER JOIN PRODUCT B
                 ON A.PRO_SEQ=B.PRO_SEQ
                 WHERE B.PRO_NAME LIKE #{search}
                 or A.USER_ID LIKE #{search}
                 ) Z INNER JOIN PHOTO Y
                 ON Z.PRO_SEQ=Y.PRO_SEQ
             INNER JOIN PRO_DETAIL X
                 ON Z.PRO_SEQ=X.PRO_SEQ
             INNER JOIN DELIVERY W
                 ON Z.PRO_SEQ=W.PRO_SEQ 
                 AND Z.USER_ID=W.USER_ID
                 AND Z.DEL_SEQ = W.DEL_SEQ	
             WHERE Y.STORED_NAME LIKE 'MAIN%' 
             AND X.PRO_SIZE=Z.SEL_SIZE  
             AND X.COLOR=Z.SEL_COLOR
            
             AND Z.SELTIME BETWEEN TO_DATE(${START_DATE}) 
             AND TO_DATE(${END_DATE})  
             
             ORDER BY Z.SEL_SEQ DESC
         ) T1
NATURAL JOIN
  	(
     SELECT COUNT(*) TOT_CNT
     FROM SALES A LEFT OUTER JOIN PRODUCT B
     ON A.PRO_SEQ=B.PRO_SEQ
     WHERE (B.PRO_NAME LIKE #{search}
     or A.USER_ID LIKE #{search})
     AND A.SEL_TIME BETWEEN TO_DATE(${START_DATE}) 
             AND TO_DATE(${END_DATE}) 
     ) T2
  	) TT1
  	WHERE RNUM BETWEEN (#{PAGE_SIZE} * (#{PAGE_NUM}-1)+1) and ((#{PAGE_SIZE}*(#{PAGE_NUM}-1))+#{PAGE_SIZE})
</select>

<insert id="do_insert_photo" parameterType="hashmap">
INSERT
INTO PHOTO
  (
    PHOTO_SEQ,
    STORED_NAME,
    ORIGINAL_NAME
  )
  VALUES
  (
    ${SEQ},
    #{ORIGINAL_FILE_NAME},
    #{STORED_FILE_NAME}
  )
</insert>

<select id="do_search_review" parameterType="hashmap" resultType="com.eagle.men_in_black.model.CeoMypageDto">
SELECT TT1.*
  FROM (
       SELECT ROWNUM RNUM,T1.*,T2.*
       FROM(

SELECT A.REV_SEQ,B.PRO_NAME,A.REV_TITLE,A.REV_TIME,A.SCORE,B.ITEM
FROM REVIEW A INNER JOIN PRODUCT B
ON A.PRO_SEQ = B.PRO_SEQ 
WHERE A.REV_STEP = 'N' AND 
B.ITEM=#{ITEM}
) T1
NATURAL JOIN
(
	SELECT COUNT(*) TOT_CNT
	FROM REVIEW A INNER JOIN PRODUCT B
	ON A.PRO_SEQ = B.PRO_SEQ 
	WHERE A.REV_STEP = 'N' AND 
	B.ITEM=#{ITEM} 
) T2
  	) TT1
WHERE RNUM BETWEEN (#{PAGE_SIZE} * (#{PAGE_NUM}-1)+1) and ((#{PAGE_SIZE}*(#{PAGE_NUM}-1))+#{PAGE_SIZE})
</select>

<select id="do_search_QnA" parameterType="hashmap" resultType="com.eagle.men_in_black.model.CeoMypageDto">
SELECT TT1.*
  FROM (
       SELECT ROWNUM RNUM,T1.*,T2.*
       FROM(

SELECT A.QNA_SEQ,B.PRO_NAME,A.QNA_TITLE,A.QNA_TIME,B.ITEM,A.QNA_TYPE
FROM QNA A INNER JOIN PRODUCT B
ON A.PRO_SEQ = B.PRO_SEQ 
WHERE A.QNA_STEP = 'N' AND 
B.ITEM=#{ITEM}
) T1
NATURAL JOIN
(
	SELECT COUNT(*) TOT_CNT
	FROM QNA A INNER JOIN PRODUCT B
	ON A.PRO_SEQ = B.PRO_SEQ 
	WHERE A.QNA_STEP = 'N' AND 
	B.ITEM=#{ITEM}
) T2
  	) TT1
WHERE RNUM BETWEEN (#{PAGE_SIZE} * (#{PAGE_NUM}-1)+1) and ((#{PAGE_SIZE}*(#{PAGE_NUM}-1))+#{PAGE_SIZE})
</select>

<select id="do_search_delstep" parameterType="int" resultType="String">
SELECT DEL_STEP FROM DELIVERY WHERE DEL_SEQ = #{SEQ}
</select>

<update id="do_update_delstep" parameterType="hashmap" >
UPDATE DELIVERY SET DEL_STEP=#{delstep} 
WHERE DEL_SEQ = #{del_seq}
</update>

<insert id="do_insert_product" parameterType="hashmap">
INSERT
INTO PRODUCT
  (
    PRO_SEQ,
    PRO_DETAIL,
    PRO_NAME,
    ITEM,
    SUB_ITEM,
    PRO_PRICE,
    MATERIAL,
    WASH,
    BODYTYPE,
    PRO_CONTENT,
    NEW_ITEM
  )
  VALUES
  (
    #{pro_seq},
    #{pro_detail},
    #{pro_name},
    #{item},
    #{sub_item},
    #{pro_price},
  	#{material},
    #{wash},
    #{bodytype},
    #{pro_content},
   	#{new_item}
  )
</insert>

</mapper>